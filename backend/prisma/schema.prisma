// PokerNow Database Schema
// Prisma + SQLite

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// プレイヤー（ユーザー）
// ============================================
model Player {
  id             String   @id @default(cuid())
  pokerName      String
  displaySetting String   @default("public") // public, masked, hidden
  authProvider   String   // apple, google, phone
  email          String?
  role           String   @default("player") // guest, player, admin
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // リレーション
  seatings Seating[]

  @@map("players")
}

// ============================================
// 店舗
// ============================================
model Shop {
  id             String   @id @default(cuid())
  name           String
  address        String
  imageUrl       String?
  latitude       Float?
  longitude      Float?
  openTime       String?
  closeTime      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // リレーション
  tables      Table[]
  events      Event[]
  tournaments Tournament[]

  @@map("shops")
}

// ============================================
// 卓（テーブル）
// ============================================
model Table {
  id        String   @id @default(cuid())
  shopId    String
  name      String
  qrCode    String   @unique
  maxSeats  Int      @default(9)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  // リレーション
  shop     Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  seatings Seating[]

  @@map("tables")
}

// ============================================
// 着席
// ============================================
model Seating {
  id         String    @id @default(cuid())
  playerId   String
  shopId     String
  tableId    String
  seatNumber Int?
  status     String    @default("active") // active, left
  seatedAt   DateTime  @default(now())
  leftAt     DateTime?

  // リレーション
  player Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  table  Table  @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@map("seatings")
}

// ============================================
// イベント
// ============================================
model Event {
  id          String   @id @default(cuid())
  shopId      String
  title       String
  description String?
  startTime   String
  endTime     String?
  createdAt   DateTime @default(now())

  // リレーション
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("events")
}

// ============================================
// トーナメント
// ============================================
model Tournament {
  id               String    @id @default(cuid())
  shopId           String
  name             String
  status           String    @default("waiting") // waiting, running, paused, break, finished
  currentLevel     Int       @default(1)
  remainingSeconds Int       @default(1200)
  structure        String    // JSON string for structure array
  entryFee         Int?
  startingStack    Int?
  createdAt        DateTime  @default(now())
  startedAt        DateTime?

  // リレーション
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("tournaments")
}
